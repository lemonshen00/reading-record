# 第一部分 数据系统的基石
## 第一章 可用性 可扩展性 可维护性
### 关于数据系统的思考
- 工具之间的界限越来越模糊：数据存储（Redis）可以被当成消息队列用，消息队列（Apache Kafka）可以被当成数据存储使用（可持久性保存数据）。
- 应用程序本质是做数据处理和存储，可以通过一系列工具完成，而工具之间数据一致性，由应用程序保证。
- 如，使缓存/索引与主数据库保持同步是应用代码的责任。
![image](https://user-images.githubusercontent.com/13763576/198508227-afd1df8d-fb3f-4bab-b8d3-56b8af0757ef.png)

- 应用程序编程接口（API, Application Programming Interface），隐藏系统内部各个工具的细节。缓存在写入时会作废或更新，以便外部客户端获取一致的结果（这是一种缓存更新机制）。
- 可靠性（Reliability）：系统在困境（adversity）（硬件故障、软件故障、人为错误）中仍可正常工作（正确完成功能，并能达到期望的性能水准）。
- 可扩展性（Scalability）：有合理的办法应对系统的增长（数据量、流量、复杂性）
- 可维护性（Maintainability）：许多不同的人（工程师、运维）在不同的生命周期，都能高效地在系统上工作（使系统保持现有行为，并适应新的应用场景）。

### 可靠性
- 可靠性粗略理解为“即使出现问题，也能继续正确工作”。造成错误的原因叫做`故障`，能预料并应对故障的系统特性可称为`容错`。
- 注故障（fault）不同于`失效`（failure）。故障通常定义为系统的一部分状态偏离其标准，而失效则是系统作为一个整体停止向用户提供服务。

#### 硬件故障
硬盘崩溃，内存出错，机房断电，有人拔错网线。
- 硬盘的平均无故障时间（MTTF mean time to failure） 约为10到50年。因此从数学期望上讲，在拥有10000个磁盘的存储集群上，平均每天会有1个磁盘出故障。磁盘可以组建RAID
- 磁盘可以组建RAID，服务器可能有双路电源和热插拔CPU，数据中心可能有电池和柴油发电机作为后备电源，某个组件挂掉时冗余组件可以立刻接管。
- 如果在硬件冗余的基础上进一步引入软件容错机制，那么系统在容忍整个（单台）机器故障的道路上就更进一步了。例如：如果需要重启机器（例如应用操作系统安全补丁），单服务器系统就需要计划停机。而允许机器失效的系统则可以一次修复一个节点，无需整个系统停机。

#### 软件错误（bug）
软件错误难以预料，而且因为是跨节点`相关`的，所以比起`不相关`的硬件故障往往可能造成更多的系统失效。例子包括：

- 接受特定的错误输入，便导致所有应用服务器实例崩溃的BUG。例如2012年6月30日的闰秒，由于Linux内核中的一个错误，许多应用同时挂掉了。
- 失控进程会占用一些共享资源，包括CPU时间、内存、磁盘空间或网络带宽。
- 系统依赖的服务变慢，没有响应，或者开始返回错误的响应。
- 级联故障，一个组件中的小故障触发另一个组件中的故障，进而触发更多的故障。
解决办法：
- 仔细考虑系统中的假设和交互
- 彻底的测试
- 进程隔离
- 允许进程崩溃并重启
- 测量、监控并分析生产环境中的系统行为
- 如果系统能够提供一些保证（例如在一个消息队列中，进入与发出的消息数量相等），那么系统就可以在运行时不断`自检`，并在出现差异（discrepancy）时报警

#### 人为错误
人类也是不可靠的。一项关于大型互联网服务的研究发现，运维配置错误是导致服务中断的首要原因，而硬件故障（服务器或网络）仅导致了10-25％的服务中断。
解决办法：
- 精心设计的抽象、API和管理后台使做对事情更容易，搞砸事情更困难。但如果接口限制太多，人们就会忽略它们的好处而想办法绕开。很难正确把握这种微妙的平衡。
- 将人们最容易犯错的地方与可能导致失效的地方解耦（decouple）。特别是提供一个功能齐全的非生产环境沙箱（sandbox），使人们可以在不影响真实用户的情况下，使用真实数据安全地探索和实验。
- 在各个层次进行彻底的测试
- 允许从人为错误中简单快速地恢复，例如，快速回滚配置变更，分批发布新代码，并提供数据重算工具（以备旧的计算出错）。
- 配置详细和明确的监控，比如性能指标和错误率
- 良好的管理实践与充分的培训

### 可扩展性
可扩展性（Scalability） 是用来描述系统应对`负载增长`能力的术语

#### 描述负载
负载可以用一些称为`负载参数（load parameters）`的数字来描述。参数的最佳选择取决于系统架构，它可能是每秒向Web服务器发出的请求、数据库中的读写比率、聊天室中同时活跃的用户数量、缓存命中率或其他东西。
- 扇出：为了服务一个传入请求而需要执行其他服务的请求数量

推特的例子
