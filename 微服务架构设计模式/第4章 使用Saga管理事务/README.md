## 4.1 微服务架构下的事务管理

跨服务的操作必须使用Saga（一种消息驱动的本地事务序列）来维护数据的一致性，而不是ACID事务。
Saga的挑战在于，只满足ACD（原子性、一致性、持久性），缺少传统ACID事务的隔离性。

### 4.1.1 微服务架构对分布式事务的需求
在单体应用中，只需要在函数名上加一个@Transational注解，就可以利用Spring框架提供的机制实现事务。
与之相反，微服务中需要实现跨多个微服务，访问多个数据库，在多个数据中实现一致性存在难度。

### 4.1.2 分布式事务的挑战
在多个服务、数据库和消息代理之间维持数据一致性的传统方式是采用分布式事务。
分布式事务的事实标准是XA，XA采用了`两阶段提交`来保证事务中的所有参与方同时完成提交，或者在失败时同时回滚。

想要使用分布式事务，则系统内的所有数据库、消息组件等都需要满足XA标准。但是很多NoSQL数据库（如MongoDB）不支持
XA标准的分布式事务。同样，一些消息代理如RabbiMQ和Kafka也不支持分布式事务。

分布式事务的另一个问题在于，它们本质上都是同步进程间通信，这会降低分布式系统的可用性。例如，为了让一个分布式事务完成
提交，所有参与事务的服务都必须可用。即分布式事务每增加一个事务参与方，都会进一步降低总体的可用性。

> 系统只能够在一致性、可用性和分区容错性三个属性中，同时保证两个 ----Eric Brewer

今天，架构师倾向于保证系统的可用性和分区容错性，放弃对数据强一致性的要求。

### 4.1.3 使用Saga模式维护数据一致性
Saga是一种在微服务架构中维护数据一致性的机制，它可以避免分布式事务带来的问题。
一个Saga表示需要更新多个服务中数据的一个系统操作。
Saga由一连串的本地事务组成，每一个本地事务负责更新它所在服务的私有数据库，这些操作依赖于ACID框架和函数库。

> 模式：Saga
> 
> 通过使用异步消息来协调一系列的本地事务，从而维护多个服务之间的数据一致性。

#### Saga使用补偿事务来回滚所做出的改变
传统ACID事务的一个重要特性是：可以轻松回滚事务，例如通过执行ROLLBACK语句，数据库可以撤销（回滚）目前为止所做的所有更改。

遗憾的是，Saga无法自动回滚，因为每个步骤都会将其更改提交到本地数据库。你必须编写所谓的*补偿事务*


![screen_shot_1686211072495](https://github.com/lemonshen00/reading-record/assets/13763576/cef8073c-f490-4363-b207-9ad488ed209a)






