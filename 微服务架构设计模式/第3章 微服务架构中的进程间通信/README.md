## 3.1 微服务架构中的进程间通信概述
通信机制：基于同步请求/响应的，如HTTP REST或gRPC；
也可以用异步的基于消息的通信机制，比如AMQP(Advanced Message Queuing Protocol，如RabbitMQ)或者STOMP(Streaming Text Orientated Message Protocol)。

消息的格式：基于文本的如JSON或XML；或更加高效的，基于二进制的Avro或Protocol Buffers格式

### 3.1.1 交互方式

- 一对一：每个客户端请求由一个服务实例来处理
- 一对多：每个客户端请求由多个服务实例来处理

如果使用了同步模式，则两个服务间是紧耦合的。

单向通知：客户端的请求发到服务端，但是并不期望服务端做出任何响应。
发布/订阅方式：客户端发布通知消息，被零个或多个感兴趣的服务订阅。
发布/异步响应方式：客户端发布请求消息，然后等待从感兴趣的服务发回的响应。

Java中为什么要设计接口？
因为接口可以给客户端调用，而实现了接口的类则对外不可见。

### 3.1.3 API的演化

应该进行次要并且向后兼容的改变，向后兼容 = 非破坏性改变，即老的客户端还能用

#### 向后兼容的更改是对API的附加更改或功能增强：
- 添加可选的属性
- 向响应添加属性
- 添加新操作

如果仅进行这些类型的更改，那么老版本的客户端将能够直接使用更新的服务。但是，服务应该为缺少的请求属性提供默认只。同样，客户端应该忽略额外的响应属性。

#### 进行主要并且不向后兼容的改变
一段时间内新旧版本API共存，可通过在URL中嵌入主要的版本号，如/v1/…，或/v2/…

或者使用HTTP的内容协商机制，并在MIME类型中包含版本号。如下：
GET /orders/xyz HTTP/1.1
Accept: application/vnd.example.resource+json; version=1

### 3.1.4 消息的格式
进程间通信的本质是交换消息。消息通常包含数据，需要决定数据的格式。
如果选择gRPC，其已经确定了消息格式；但如果选择类似于HTTP的消息系统，就需要选择消息的格式。

不应该选择类似Java序列化这样跟编程语言强相关的消息格式。

#### 基于文本的消息格式
如JSON或XML，好处是可读性高，同时是字描述的。

缺点是：消息过于冗长，如需要反复包含除了值以外的属性名称。另外，解析文本引入额外的开销。

#### 二进制消息格式

Protocol Buffers和Avro

## 3.2 基于同步远程过程调用模式的通信




### 3.2.1 使用REST
REST中的一个关键概念是资源，它通常表示单个业务对象，例如客户或产品，或业务对象的集合。REST使用HTTP动词来操作资源，如GET 请求返回资源，POST请求创建资源，PUT请求更新资源。例如 POST/order，GET/orders/{orderId}

#### 挑战：在一个请求中获取多种资源
如何一个REST请求获取多种资源，如一次获取订单和顾客信息？

GET/orders/ order-id-1345?expand=consumer 检素order 及其 Consumer。
请求中的查询参数用来指定要与 order一起返回的相关资源，但方法很耗时。

可以通过GraphQL技术解决。

#### 挑战：把操作映射为 HTTP 动词
另一个常见的 REST API 设计问题是如何将要在业务对象上执行的操作映射到 HTTP 动词。REST API应该使用 PUT 进行更新，但可能有多种方法更新订单，包括取消订单、修改订单等，解决办法：POST/orders/ {orderId}/cancel，但不符合RESTful的要求。

映射到HTTP动作这个挑战导致了REST替代方案的日益普及，如gRPC。

#### REST的好处
•它非常简单，并且大家都很熟悉。
•可以使用浏览器扩展（比如Postman插件）或者curl 之类的命令行（假设使用的是
JSON 或其他文本格式）来测试 HTTP API
•直接支持请求 /响应方式的通信。
•HTTP 对防火墙友好。
•不需要中间代理，简化了系统架构。

它也存在一些弊端：

•它只支持请求 / 响应方式的通信。
•可能导致可用性降低。由于客户端和服务直接通信而没有代理来缓冲消息，因此它们必须在 REST API 调用期间都保持在线。
•客户端必须知道服务实例的位置（URL)。
•在单个请求中获取多个资源具有挑战性。
•有时很难将多个更新操作映射到 HTTP 动词。


### 3.2.2 使用gRPC
gRPC使用基于PB的IDL语言定义API。除了支持简单的请求/响应RPC外，还支持流式RPC。服务器可以使用消息流回复客广端。客户端也可以向服务器发送消息流。

gRPC使用PB作为消息格式，无他选。gRPC向后兼容，因为Protocol Buffers 消息的每个字段都有编号，消息接收方可以提取所需的字段，并跳过它无法识別的字段（未来的新字段）。

gRPC 有几个好处：
- 设计具有复杂更新操作的 API 非常简单。
- 它具有高效、紧凑的进程问通信机制，尤其是在交换大量消息时。
- 支持在远程过程调用和消息传递过程中使用双向流式消息方式。
- 它实现了客户端和用各种语言编写的服务端之间的互操作性。

gRPC也有几个弊端：
- 与其于 REST 的 API机制相比，Javascript 客户端使用基于gRPC 的 API需要做更多的工作。
- 旧式防火墙可能不支持 HTTP/2。

### 3.2.3 使用阻断器模式处理局部故障
